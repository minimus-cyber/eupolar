<%- include('../partials/header') %>

<h2>Lifechart - Grafico dell'Umore</h2>

<div class="card">
  <h3>Aggiungi Nuova Registrazione</h3>
  <form method="POST" action="/user/lifechart">
    <div class="grid">
      <div class="form-group">
        <label for="date">Data:</label>
        <input type="date" id="date" name="date" required value="<%= new Date().toISOString().split('T')[0] %>">
      </div>

      <div class="form-group">
        <label for="mood_level">Livello di Umore (-3 a +3):</label>
        <input type="range" id="mood_level" name="mood_level" min="-3" max="3" value="0" oninput="document.getElementById('mood_value').textContent = this.value">
        <div class="range-value">
          <span id="mood_value">0</span>
          <div style="font-size: 0.9rem; color: #666;">-3 = Molto depresso | 0 = Neutro | +3 = Molto euforico</div>
        </div>
      </div>

      <div class="form-group">
        <label for="sleep_hours">Ore di Sonno:</label>
        <input type="number" id="sleep_hours" name="sleep_hours" step="0.5" min="0" max="24">
      </div>

      <div class="form-group">
        <label for="medications">Farmaci Assunti:</label>
        <input type="text" id="medications" name="medications" placeholder="es. Litio 900mg, Quetiapina 200mg">
      </div>
    </div>

    <div class="form-group">
      <label for="notes">Note:</label>
      <textarea id="notes" name="notes" placeholder="Eventi significativi, sintomi, osservazioni..."></textarea>
    </div>

    <button type="submit" class="btn">Salva Registrazione</button>
  </form>
</div>

<div class="card">
  <h3>Storico Registrazioni (Ultime 30)</h3>
  
  <% if (entries && entries.length > 0) { %>
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Umore</th>
            <th>Ore Sonno</th>
            <th>Farmaci</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          <% entries.forEach(entry => { %>
            <tr>
              <td><%= entry.date %></td>
              <td>
                <% 
                  let moodText = '';
                  if (entry.mood_level >= 2) moodText = 'ðŸ˜„ +' + entry.mood_level;
                  else if (entry.mood_level == 1) moodText = 'ðŸ™‚ +1';
                  else if (entry.mood_level == 0) moodText = 'ðŸ˜ 0';
                  else if (entry.mood_level == -1) moodText = 'ðŸ˜• -1';
                  else moodText = 'ðŸ˜ž ' + entry.mood_level;
                %>
                <%= moodText %>
              </td>
              <td><%= entry.sleep_hours || '-' %></td>
              <td><%= entry.medications || '-' %></td>
              <td><%= entry.notes || '-' %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    
    <div style="margin-top: 2rem;">
      <canvas id="moodChart" style="max-height: 400px;"></canvas>
    </div>

    <script>
      // Simple chart visualization
      const entries = <%- JSON.stringify(entries.slice().reverse()) %>;
      const canvas = document.getElementById('moodChart');
      const ctx = canvas.getContext('2d');
      
      canvas.width = canvas.parentElement.offsetWidth;
      canvas.height = 300;
      
      const padding = 40;
      const width = canvas.width - 2 * padding;
      const height = canvas.height - 2 * padding;
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw axes
      ctx.beginPath();
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();
      
      // Draw zero line
      ctx.beginPath();
      ctx.strokeStyle = '#ccc';
      ctx.lineWidth = 1;
      const zeroY = padding + height / 2;
      ctx.moveTo(padding, zeroY);
      ctx.lineTo(canvas.width - padding, zeroY);
      ctx.stroke();
      
      // Draw grid lines and labels
      ctx.font = '12px Arial';
      ctx.fillStyle = '#666';
      for (let i = -3; i <= 3; i++) {
        const y = zeroY - (i * height / 6);
        ctx.fillText(i.toString(), padding - 25, y + 4);
        
        ctx.beginPath();
        ctx.strokeStyle = '#eee';
        ctx.moveTo(padding, y);
        ctx.lineTo(canvas.width - padding, y);
        ctx.stroke();
      }
      
      if (entries.length > 0) {
        // Draw mood line
        ctx.beginPath();
        ctx.strokeStyle = '#2c5aa0';
        ctx.lineWidth = 2;
        
        entries.forEach((entry, index) => {
          const x = padding + (index / Math.max(entries.length - 1, 1)) * width;
          const y = zeroY - (entry.mood_level * height / 6);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.stroke();
        
        // Draw points
        entries.forEach((entry, index) => {
          const x = padding + (index / Math.max(entries.length - 1, 1)) * width;
          const y = zeroY - (entry.mood_level * height / 6);
          
          ctx.beginPath();
          ctx.fillStyle = entry.mood_level > 0 ? '#ff6b6b' : entry.mood_level < 0 ? '#6bb6ff' : '#666';
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
        });
      }
    </script>
  <% } else { %>
    <p>Nessuna registrazione ancora. Inizia ad aggiungere i tuoi dati!</p>
  <% } %>
</div>

<div class="card">
  <h3>ðŸ’¡ Suggerimenti per l'uso del Lifechart</h3>
  <ul style="margin-left: 2rem;">
    <li>Registra i dati ogni giorno alla stessa ora per maggiore consistenza</li>
    <li>Sii onesto nelle valutazioni - i dati sono solo per te e il tuo medico</li>
    <li>Annota eventi significativi che potrebbero influenzare l'umore</li>
    <li>Porta il grafico alle visite mediche per discutere i pattern</li>
    <li>Cerca di identificare fattori scatenanti o protettivi</li>
  </ul>
</div>

<%- include('../partials/footer') %>
