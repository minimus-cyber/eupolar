<%- include('../partials/header') %>

<h2>Lifechart - Questionario Diagnostico</h2>

<div class="card">
  <h3>Benvenuto al Questionario Lifechart</h3>
  <p>Questo questionario ti aiuter√† a creare una visualizzazione della tua storia di vita e dell'andamento dell'umore nel tempo. Le domande si adatteranno alla tua et√† e alle tue risposte.</p>
  <p><strong>Tempo stimato:</strong> 10-15 minuti</p>
  <p><strong>Privacy:</strong> Le tue risposte sono confidenziali e verranno utilizzate solo per generare il tuo lifechart personale.</p>
</div>

<% if (lifechart) { %>
  <div class="card">
    <h3>Il tuo Lifechart Generato</h3>
    <p><strong>Data compilazione:</strong> <%= new Date(lifechart.created_at).toLocaleDateString('it-IT') %></p>
    
    <div style="margin-top: 2rem;">
      <canvas id="lifechartCanvas" style="max-height: 400px;"></canvas>
    </div>
    
    <div style="margin-top: 2rem;">
      <h4>Riepilogo della tua storia</h4>
      <% if (lifechart.data) { %>
        <% const data = JSON.parse(lifechart.data); %>
        <ul style="margin-left: 2rem;">
          <li><strong>Anno di nascita:</strong> <%= data.birth_year || 'Non specificato' %></li>
          <li><strong>Et√† attuale:</strong> <%= data.current_age || 'Non specificata' %> anni</li>
          <li><strong>Et√† primo episodio:</strong> <%= data.first_episode_age || 'Non specificata' %> anni</li>
          <li><strong>Numero episodi depressivi:</strong> <%= data.depressive_episodes || '0' %></li>
          <li><strong>Numero episodi maniacali/ipomaniacali:</strong> <%= data.manic_episodes || '0' %></li>
          <li><strong>Ricoveri ospedalieri:</strong> <%= data.hospitalizations || '0' %></li>
        </ul>
      <% } %>
    </div>
    
    <div style="margin-top: 1.5rem;">
      <a href="/user/lifechart/edit" class="btn">Modifica Questionario</a>
      <button id="restartBtn" class="btn" style="background: #666;">Ricomincia da Capo</button>
    </div>

    <script>
      // Handle restart button
      document.getElementById('restartBtn').addEventListener('click', function() {
        if(confirm('Sei sicuro di voler rifare il questionario? I dati attuali verranno sovrascritti.')) {
          window.location.href='/user/lifechart/new';
        }
      });
      
      // Render lifechart from data
      const lifechartData = JSON.parse('<%- JSON.stringify(JSON.stringify(lifechart.data)) %>');
      const canvas = document.getElementById('lifechartCanvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = canvas.parentElement.offsetWidth;
      canvas.height = 300;
      
      const padding = 40;
      const width = canvas.width - 2 * padding;
      const height = canvas.height - 2 * padding;
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw axes
      ctx.beginPath();
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();
      
      // Draw zero line (euthymic state)
      ctx.beginPath();
      ctx.strokeStyle = '#4CAF50';
      ctx.lineWidth = 1;
      const zeroY = padding + height / 2;
      ctx.moveTo(padding, zeroY);
      ctx.lineTo(canvas.width - padding, zeroY);
      ctx.stroke();
      
      // Labels
      ctx.font = '12px Arial';
      ctx.fillStyle = '#666';
      ctx.fillText('Mania/Ipomania', padding - 35, padding + 10);
      ctx.fillText('Eutimia', padding - 35, zeroY);
      ctx.fillText('Depressione', padding - 35, canvas.height - padding - 5);
      
      // Draw age labels on x-axis
      const birthYear = lifechartData.birth_year || new Date().getFullYear() - (lifechartData.current_age || 30);
      const currentAge = lifechartData.current_age || 30;
      
      for (let age = 0; age <= currentAge; age += 5) {
        const x = padding + (age / currentAge) * width;
        ctx.fillText(age.toString(), x - 5, canvas.height - padding + 20);
      }
      
      // Draw lifecycle events
      if (lifechartData.timeline && lifechartData.timeline.length > 0) {
        ctx.beginPath();
        ctx.strokeStyle = '#2c5aa0';
        ctx.lineWidth = 2;
        
        lifechartData.timeline.forEach((point, index) => {
          const x = padding + (point.age / currentAge) * width;
          // Map mood from -3 to +3 to canvas y coordinate
          const y = zeroY - (point.mood * height / 6);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.stroke();
        
        // Draw points for episodes
        lifechartData.timeline.forEach((point) => {
          const x = padding + (point.age / currentAge) * width;
          const y = zeroY - (point.mood * height / 6);
          
          ctx.beginPath();
          if (point.type === 'manic' || point.type === 'hypomanic') {
            ctx.fillStyle = '#ff6b6b';
          } else if (point.type === 'depressive') {
            ctx.fillStyle = '#6bb6ff';
          } else {
            ctx.fillStyle = '#4CAF50';
          }
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fill();
          
          // Add label for significant events
          if (point.label) {
            ctx.fillStyle = '#333';
            ctx.font = '10px Arial';
            ctx.fillText(point.label, x - 15, y - 10);
          }
        });
      }
    </script>
  </div>
<% } else { %>
  <div class="card">
    <h3>Inizia il Questionario</h3>
    <form method="POST" action="/user/lifechart/submit">
      
      <h4 style="margin-top: 1.5rem;">Informazioni Generali</h4>
      
      <div class="form-group">
        <label for="birth_year">Anno di nascita:</label>
        <input type="number" id="birth_year" name="birth_year" required min="1900" max="<%= new Date().getFullYear() %>" placeholder="es. 1985">
      </div>
      
      <div class="form-group">
        <label for="current_age">Et√† attuale:</label>
        <input type="number" id="current_age" name="current_age" required min="1" max="120" placeholder="es. 38">
      </div>
      
      <h4 style="margin-top: 1.5rem;">Storia Clinica</h4>
      
      <div class="form-group">
        <label for="diagnosis_age">A che et√† hai ricevuto la diagnosi di disturbo bipolare? (lascia vuoto se non ancora diagnosticato)</label>
        <input type="number" id="diagnosis_age" name="diagnosis_age" min="0" max="120" placeholder="es. 28">
      </div>
      
      <div class="form-group">
        <label for="first_episode_age">A che et√† hai avuto il primo episodio significativo di alterazione dell'umore?</label>
        <input type="number" id="first_episode_age" name="first_episode_age" min="0" max="120" placeholder="es. 23">
      </div>
      
      <div class="form-group">
        <label for="first_episode_type">Che tipo di episodio √® stato?</label>
        <select id="first_episode_type" name="first_episode_type">
          <option value="">Seleziona...</option>
          <option value="depressive">Episodio Depressivo</option>
          <option value="manic">Episodio Maniacale</option>
          <option value="hypomanic">Episodio Ipomaniacale</option>
          <option value="mixed">Episodio Misto</option>
          <option value="unknown">Non ricordo/Non so</option>
        </select>
      </div>
      
      <h4 style="margin-top: 1.5rem;">Episodi Depressivi</h4>
      
      <div class="form-group">
        <label for="depressive_episodes">Quanti episodi depressivi significativi hai avuto nella tua vita?</label>
        <input type="number" id="depressive_episodes" name="depressive_episodes" min="0" max="100" value="0">
        <small style="color: #666;">Considera episodi che hanno durato almeno 2 settimane e hanno impattato significativamente la tua vita</small>
      </div>
      
      <div class="form-group">
        <label for="worst_depression_age">A che et√† hai avuto l'episodio depressivo pi√π grave?</label>
        <input type="number" id="worst_depression_age" name="worst_depression_age" min="0" max="120" placeholder="es. 30">
      </div>
      
      <div class="form-group">
        <label for="depression_duration">Quanto sono durati in media i tuoi episodi depressivi?</label>
        <select id="depression_duration" name="depression_duration">
          <option value="">Seleziona...</option>
          <option value="weeks">Alcune settimane</option>
          <option value="months">Alcuni mesi (2-6)</option>
          <option value="long">Molti mesi (6+)</option>
          <option value="chronic">Pi√π di un anno</option>
        </select>
      </div>
      
      <h4 style="margin-top: 1.5rem;">Episodi Maniacali/Ipomaniacali</h4>
      
      <div class="form-group">
        <label for="manic_episodes">Quanti episodi maniacali o ipomaniacali hai avuto nella tua vita?</label>
        <input type="number" id="manic_episodes" name="manic_episodes" min="0" max="100" value="0">
        <small style="color: #666;">Include sia episodi maniacali completi che episodi ipomaniacali pi√π lievi</small>
      </div>
      
      <div class="form-group">
        <label for="worst_mania_age">A che et√† hai avuto l'episodio maniacale/ipomaniacale pi√π grave?</label>
        <input type="number" id="worst_mania_age" name="worst_mania_age" min="0" max="120" placeholder="es. 25">
      </div>
      
      <div class="form-group">
        <label for="mania_duration">Quanto sono durati in media i tuoi episodi maniacali/ipomaniacali?</label>
        <select id="mania_duration" name="mania_duration">
          <option value="">Seleziona...</option>
          <option value="days">Alcuni giorni</option>
          <option value="weeks">1-2 settimane</option>
          <option value="longer">Pi√π di 2 settimane</option>
          <option value="months">Pi√π di un mese</option>
        </select>
      </div>
      
      <h4 style="margin-top: 1.5rem;">Trattamenti e Ricoveri</h4>
      
      <div class="form-group">
        <label for="treatment_start_age">A che et√† hai iniziato un trattamento farmacologico per il disturbo dell'umore?</label>
        <input type="number" id="treatment_start_age" name="treatment_start_age" min="0" max="120" placeholder="es. 28">
      </div>
      
      <div class="form-group">
        <label for="hospitalizations">Quante volte sei stato ricoverato in ospedale per problemi legati all'umore?</label>
        <input type="number" id="hospitalizations" name="hospitalizations" min="0" max="50" value="0">
      </div>
      
      <div class="form-group">
        <label for="psychotherapy">Hai fatto o stai facendo psicoterapia?</label>
        <select id="psychotherapy" name="psychotherapy">
          <option value="">Seleziona...</option>
          <option value="no">No, mai</option>
          <option value="past">S√¨, in passato</option>
          <option value="current">S√¨, attualmente</option>
          <option value="on-off">S√¨, a periodi alterni</option>
        </select>
      </div>
      
      <h4 style="margin-top: 1.5rem;">Periodi di Stabilit√†</h4>
      
      <div class="form-group">
        <label for="longest_stable_period">Qual √® stato il periodo pi√π lungo in cui ti sei sentito stabile (eutimico)?</label>
        <select id="longest_stable_period" name="longest_stable_period">
          <option value="">Seleziona...</option>
          <option value="weeks">Alcune settimane</option>
          <option value="months">Alcuni mesi (2-6)</option>
          <option value="year">Circa un anno</option>
          <option value="years">Pi√π di un anno</option>
          <option value="many-years">Diversi anni</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="current_state">Come descriveresti il tuo stato attuale?</label>
        <select id="current_state" name="current_state">
          <option value="">Seleziona...</option>
          <option value="euthymic">Eutimico (stabile)</option>
          <option value="mild-depression">Lievemente depresso</option>
          <option value="moderate-depression">Moderatamente depresso</option>
          <option value="severe-depression">Gravemente depresso</option>
          <option value="mild-hypomania">Lievemente ipomaniacale</option>
          <option value="hypomania">Ipomaniacale</option>
          <option value="mania">Maniacale</option>
          <option value="mixed">Sintomi misti</option>
        </select>
      </div>
      
      <h4 style="margin-top: 1.5rem;">Fattori di Vita</h4>
      
      <div class="form-group">
        <label for="life_events">Ci sono stati eventi di vita significativi che hanno influenzato il decorso del disturbo?</label>
        <textarea id="life_events" name="life_events" placeholder="es. Perdita di una persona cara, cambio di lavoro, nascita di un figlio, divorzio, trasloco importante..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="seasonal_pattern">Hai notato un pattern stagionale nei tuoi episodi?</label>
        <select id="seasonal_pattern" name="seasonal_pattern">
          <option value="">Seleziona...</option>
          <option value="no">No, nessun pattern particolare</option>
          <option value="winter-depression">Depressione in inverno</option>
          <option value="spring-mania">Mania/ipomania in primavera</option>
          <option value="summer-mania">Mania/ipomania in estate</option>
          <option value="fall-depression">Depressione in autunno</option>
          <option value="other">Altro pattern</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="additional_notes">Note aggiuntive o informazioni che ritieni importanti:</label>
        <textarea id="additional_notes" name="additional_notes" placeholder="Qualsiasi altra informazione che vuoi aggiungere al tuo lifechart..."></textarea>
      </div>
      
      <button type="submit" class="btn">Genera Lifechart</button>
    </form>
  </div>
<% } %>

<div class="card">
  <h3>üí° Informazioni sul Lifechart</h3>
  <ul style="margin-left: 2rem;">
    <li>Il lifechart √® uno strumento diagnostico che aiuta a visualizzare il decorso del disturbo bipolare nel tempo</li>
    <li>√à utile per identificare pattern, fattori scatenanti e periodi di stabilit√†</li>
    <li>Porta il tuo lifechart generato alle visite mediche per discutere la tua storia clinica</li>
    <li>Puoi aggiornare il lifechart in qualsiasi momento se ricordi nuovi dettagli</li>
    <li>I dati sono privati e vengono utilizzati solo per generare la tua visualizzazione personale</li>
  </ul>
</div>

<%- include('../partials/footer') %>
